package org.springblade.integrated.platform.controller;

import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;
import com.baomidou.mybatisplus.core.conditions.Wrapper;
import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.core.toolkit.Wrappers;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.github.xiaoymin.knife4j.annotations.ApiOperationSupport;
import com.vingsoft.crypto.CryptoFactory;
import com.vingsoft.crypto.CryptoType;
import com.vingsoft.entity.*;
import com.vingsoft.vo.ReportsBaseinfoVo;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import lombok.AllArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springblade.common.constant.HttpSafeConstant;
import org.springblade.common.constant.PropConstant;
import org.springblade.common.utils.VSTool;
import org.springblade.core.boot.ctrl.BladeController;
import org.springblade.core.log.logger.BladeLogger;
import org.springblade.core.mp.support.Condition;
import org.springblade.core.mp.support.Query;
import org.springblade.core.secure.BladeUser;
import org.springblade.core.secure.utils.AuthUtil;
import org.springblade.core.tenant.annotation.NonDS;
import org.springblade.core.tool.api.R;
import org.springblade.core.tool.utils.Func;
import org.springblade.core.tool.utils.SpringUtil;
import org.springblade.core.tool.utils.StringUtil;
import org.springblade.integrated.platform.common.constant.Constants;
import org.springblade.integrated.platform.common.framework.aspectj.lang.annotation.Log;
import org.springblade.integrated.platform.common.framework.aspectj.lang.enums.BusinessType;
import org.springblade.integrated.platform.common.project.monitor.operlog.service.IOperLogService;
import org.springblade.integrated.platform.common.utils.StringUtils;
import org.springblade.integrated.platform.constant.StatusConstant;
import org.springblade.integrated.platform.service.*;
import org.springblade.integrated.platform.wrapper.AppTaskWrapper;
import org.springblade.system.cache.SysCache;
import org.springblade.system.feign.IDictBizClient;
import org.springblade.system.feign.ISysClient;
import org.springblade.system.user.entity.User;
import org.springblade.system.user.feign.IUserClient;
import org.springblade.system.user.feign.IUserSearchClient;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import javax.annotation.Resource;
import javax.servlet.Registration;
import javax.validation.Valid;
import java.io.IOException;
import java.util.*;

/**
 * ÂÖ¨ÂÖ±ÊñπÊ≥ï-ÊâπÁ§∫/ÁïôË®Ä ÊéßÂà∂Â±Ç
 *
 * @Author JGüß∏
 * @Create 2022/4/9 14:30
 */
@Slf4j
@NonDS
@RestController
@AllArgsConstructor
@RequestMapping("/MessageInformation")
@Api(value = "ÂÖ¨ÂÖ±ÊñπÊ≥ï-ÊâπÁ§∫/ÁïôË®Ä", tags = "ÊâπÁ§∫/ÁïôË®ÄÊé•Âè£ÊéßÂà∂Â±Ç‰ª£Á†Å")
public class MessageInformationController extends BladeController {

	private final IMessageInformationService iMessageInformationService;
	private final IAppriseFilesService iAppriseFilesService;
	@Resource
	private final IUserClient userClient;
	@Resource
	private final IUserSearchClient iUserSearchClient;
	private final IUnifyMessageService messageService;
	@Resource
	private final IDictBizClient dictBizClient;
	private final ISupervisionLogService supervisionLogService;
	@Resource
	private final ISysClient sysClient;
	private final ISupervisionInfoService iSupervisionInfoService;
	private final IProjectSummaryService projectSummaryService;
	private final IProjectLogService projectLogService;
	private final SmsDockingService smsDockingService;
	@Resource
	private IAnnualEvaluationService annualEvaluationService;
	@Resource
	private IQuarterlyEvaluationService quarterlyEvaluationService;
	@Resource
	private ILeaderAppriseService leaderAppriseService;
	private final BladeLogger bladeLogger;
	@Resource
	private HttpSafeConstant httpSafeConstant;
	private ObjectMapper objectMapper;

	/**
	 * ËØ¶ÁªÜ‰ø°ÊÅØ
	 */
	@GetMapping("/detail")
	@ApiOperationSupport(order = 1)
	@ApiOperation(value = "ÊâπÁ§∫/ÁïôË®ÄËØ¶ÁªÜ‰ø°ÊÅØ", notes = "‰º†ÂÖ•messageInformation")
	public R<List<MessageInformation>> detail(MessageInformation messageInformation) {
		//sqlÊü•ËØ¢Êù°‰ª∂
		QueryWrapper<MessageInformation> queryWrapper = new QueryWrapper<MessageInformation>();
		queryWrapper.select(" * ");
		queryWrapper.eq(StringUtils.isNotNull(messageInformation.getBusinessId()),"business_id",messageInformation.getBusinessId());
		queryWrapper.eq(StringUtils.isNotNull(messageInformation.getMonthBusinessId()),"month_business_id",messageInformation.getMonthBusinessId());
		queryWrapper.eq(StringUtils.isNotNull(messageInformation.getPsOrLy()),"ps_or_ly",messageInformation.getPsOrLy());
		queryWrapper.eq(StringUtils.isNotBlank(messageInformation.getBusinessType()),"business_type",messageInformation.getBusinessType());
		queryWrapper.eq(StringUtils.isNotNull(messageInformation.getChildId()),"child_id",messageInformation.getChildId());
		queryWrapper.eq(StringUtils.isNotNull(messageInformation.getCreateUser()),"create_user",messageInformation.getCreateUser());
		queryWrapper.orderByDesc("create_time");
		List<MessageInformation> detail = iMessageInformationService.list(queryWrapper);

		for (MessageInformation messageInformation1 : detail) {
			if (messageInformation1.getBusinessId() != null) {
				QueryWrapper<AppriseFiles> filesQueryWrapper = new QueryWrapper<>();
				filesQueryWrapper.eq("business_id",Long.valueOf(messageInformation1.getId()));
				//filesQueryWrapper.eq("business_table",messageInformation1.getBusinessTable());
				List<AppriseFiles> appriseFilesList = iAppriseFilesService.list(filesQueryWrapper);
				messageInformation1.setAppriseFilesList(appriseFilesList);
			}
		}

		return R.data(detail);
	}

	/**
	 * ËØ¶ÁªÜ‰ø°ÊÅØ
	 */
	@PostMapping("/detailApp")
	@ApiOperationSupport(order = 1)
	@ApiOperation(value = "ÊâπÁ§∫/ÁïôË®ÄËØ¶ÁªÜ‰ø°ÊÅØ-app", notes = "‰º†ÂÖ•messageInformation")
	public R detailApp(@RequestBody Map<String, Object> map) {
		//ÂèÇÊï∞Ëß£ÂØÜ
		String params = map.get("params").toString();
		//1„ÄÅÊó•ÂøóËÆ∞ÂΩï
		bladeLogger.info("ÊâπÁ§∫/ÁïôË®ÄËØ¶ÁªÜ‰ø°ÊÅØ-app",params);
		//2„ÄÅÂèÇÊï∞Ëß£ÂØÜ
		Map<String, Object> dataMap = VSTool.decrypt(httpSafeConstant.getPrivateKey(), params, VSTool.CHN);
		if (dataMap.get("extra") != null) {
			String encryptSign = dataMap.get("sign").toString();
			JSONObject jsonParams = JSONObject.parseObject(dataMap.get("extra").toString());
			String businessId = jsonParams.getString("businessId");
			String monthBusinessId = jsonParams.getString("monthBusinessId");
			String psOrLy = jsonParams.getString("psOrLy");
			String businessType = jsonParams.getString("businessType");
			String childId = jsonParams.getString("childId");
			String createUser = jsonParams.getString("createUser");

			//sqlÊü•ËØ¢Êù°‰ª∂
			QueryWrapper<MessageInformation> queryWrapper = new QueryWrapper<>();
			queryWrapper.select(" * ");
			queryWrapper.eq(StringUtils.isNotNull(businessId),"business_id",businessId);
			queryWrapper.eq(StringUtils.isNotNull(monthBusinessId),"month_business_id",monthBusinessId);
			queryWrapper.eq(StringUtils.isNotNull(psOrLy),"ps_or_ly",psOrLy);
			queryWrapper.eq(StringUtils.isNotBlank(businessType),"business_type",businessType);
			queryWrapper.eq(StringUtils.isNotNull(childId),"child_id",childId);
			queryWrapper.eq(StringUtils.isNotNull(createUser),"create_user",createUser);
			queryWrapper.orderByDesc("create_time");
			List<MessageInformation> detail = iMessageInformationService.list(queryWrapper);

			for (MessageInformation messageInformation1 : detail) {
				if (messageInformation1.getBusinessId() != null) {
					QueryWrapper<AppriseFiles> filesQueryWrapper = new QueryWrapper<>();
					filesQueryWrapper.eq("business_id", messageInformation1.getId());
					List<AppriseFiles> appriseFilesList = iAppriseFilesService.list(filesQueryWrapper);
					messageInformation1.setAppriseFilesList(appriseFilesList);
				}
			}
			JSONArray jsonArray = objectMapper.convertValue(detail, JSONArray.class);
			return R.data(VSTool.encrypt(encryptSign, jsonArray.toString(), VSTool.CHN));
		}else{
			return R.fail("Âä†ÂØÜËß£ÊûêÈîôËØØ");
		}

	}


	/**
	 * ËØ¶ÁªÜ‰ø°ÊÅØÂàÜÈ°µ
	 */
	@GetMapping("/listPage")
	@ApiOperationSupport(order = 1)
	@ApiOperation(value = "ÊâπÁ§∫/ÁïôË®ÄËØ¶ÁªÜ‰ø°ÊÅØÂàÜÈ°µ", notes = "‰º†ÂÖ•messageInformation")
	public R<IPage<MessageInformation>> detail(MessageInformation messageInformation, Query query) {
		//sqlÊü•ËØ¢Êù°‰ª∂
		QueryWrapper<MessageInformation> queryWrapper = new QueryWrapper<MessageInformation>();
		queryWrapper.select(" * ");
		if(StringUtils.isNotEmpty(messageInformation.getBusinessType()) && messageInformation.getBusinessType().equals("5")){ //Â∑•‰ΩúÊúàË∞ÉÂ∫¶
			queryWrapper.eq(StringUtils.isNotNull(messageInformation.getMonthBusinessId()),"month_business_id",messageInformation.getMonthBusinessId());
		}else{
			queryWrapper.eq(StringUtils.isNotNull(messageInformation.getBusinessId()),"business_id",messageInformation.getBusinessId());
		}
		queryWrapper.eq(StringUtils.isNotNull(messageInformation.getPsOrLy()),"ps_or_ly",messageInformation.getPsOrLy());
		queryWrapper.eq(StringUtils.isNotNull(messageInformation.getChildId()),"child_id",messageInformation.getChildId());
		queryWrapper.eq(StringUtils.isNotBlank(messageInformation.getBusinessType()),"business_type",messageInformation.getBusinessType());
		queryWrapper.eq(StringUtils.isNotNull(messageInformation.getCreateUser()),"create_user",messageInformation.getCreateUser());
		//Êü•ËØ¢30Â§©ÂÜÖÁöÑ
		queryWrapper.apply("DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= create_time");
		queryWrapper.orderByDesc("create_time");

		//Êü•ËØ¢Êï∞ÊçÆÔºåÂ∞ÅË£ÖÂàÜÈ°µÂèÇÊï∞
		IPage<MessageInformation> detail = iMessageInformationService.page(Condition.getPage(query), queryWrapper);

		for (MessageInformation messageInformation1 : detail.getRecords()) {
			if (messageInformation1.getBusinessId() != null) {
				QueryWrapper<AppriseFiles> filesQueryWrapper = new QueryWrapper<>();
				filesQueryWrapper.eq("business_id",Long.valueOf(messageInformation1.getId()));
				List<AppriseFiles> appriseFilesList = iAppriseFilesService.list(filesQueryWrapper);
				messageInformation1.setAppriseFilesList(appriseFilesList);
			}
		}

		return R.data(detail);
	}

	/**
	 * ËØ¶ÁªÜ‰ø°ÊÅØÂàÜÈ°µ-app
	 */
	@PostMapping("/listPageApp")
	@ApiOperationSupport(order = 1)
	@ApiOperation(value = "ÊâπÁ§∫/ÁïôË®ÄËØ¶ÁªÜ‰ø°ÊÅØÂàÜÈ°µ", notes = "‰º†ÂÖ•messageInformation")
	public R listPageApp(@RequestBody Map<String, Object> map) {
		//ÂèÇÊï∞Ëß£ÂØÜ
		String params = map.get("params").toString();
		//1„ÄÅÊó•ÂøóËÆ∞ÂΩï
		bladeLogger.info("ÊâπÁ§∫/ÁïôË®ÄËØ¶ÁªÜ‰ø°ÊÅØÂàÜÈ°µ-app",params);
		//2„ÄÅÂèÇÊï∞Ëß£ÂØÜ
		Map<String, Object> dataMap = VSTool.decrypt(httpSafeConstant.getPrivateKey(), params, VSTool.CHN);
		if (dataMap.get("extra") != null) {
			String encryptSign = dataMap.get("sign").toString();
			JSONObject jsonParams = JSONObject.parseObject(dataMap.get("extra").toString());
			Query query = new Query();
			query.setCurrent(jsonParams.getInteger("current"));
			query.setSize(jsonParams.getInteger("size"));
			MessageInformation messageInformation = objectMapper.convertValue(jsonParams, MessageInformation.class);
			//sqlÊü•ËØ¢Êù°‰ª∂
			QueryWrapper<MessageInformation> queryWrapper = new QueryWrapper<MessageInformation>();
			queryWrapper.select(" * ");
			if(StringUtils.isNotEmpty(messageInformation.getBusinessType()) && messageInformation.getBusinessType().equals("5")){ //Â∑•‰ΩúÊúàË∞ÉÂ∫¶
				queryWrapper.eq(StringUtils.isNotNull(messageInformation.getMonthBusinessId()),"month_business_id",messageInformation.getMonthBusinessId());
			}else{
				queryWrapper.eq(StringUtils.isNotNull(messageInformation.getBusinessId()),"business_id",messageInformation.getBusinessId());
			}
			queryWrapper.eq(StringUtils.isNotNull(messageInformation.getPsOrLy()),"ps_or_ly",messageInformation.getPsOrLy());
			queryWrapper.eq(StringUtils.isNotNull(messageInformation.getChildId()),"child_id",messageInformation.getChildId());
			queryWrapper.eq(StringUtils.isNotBlank(messageInformation.getBusinessType()),"business_type",messageInformation.getBusinessType());
			queryWrapper.eq(StringUtils.isNotNull(messageInformation.getCreateUser()),"create_user",messageInformation.getCreateUser());
			//Êü•ËØ¢30Â§©ÂÜÖÁöÑ
			queryWrapper.apply("DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= create_time");
			queryWrapper.orderByDesc("create_time");

			//Êü•ËØ¢Êï∞ÊçÆÔºåÂ∞ÅË£ÖÂàÜÈ°µÂèÇÊï∞
			IPage<MessageInformation> detail = iMessageInformationService.page(Condition.getPage(query), queryWrapper);

			for (MessageInformation messageInformation1 : detail.getRecords()) {
				if (messageInformation1.getBusinessId() != null) {
					QueryWrapper<AppriseFiles> filesQueryWrapper = new QueryWrapper<>();
					filesQueryWrapper.eq("business_id",Long.valueOf(messageInformation1.getId()));
					List<AppriseFiles> appriseFilesList = iAppriseFilesService.list(filesQueryWrapper);
					messageInformation1.setAppriseFilesList(appriseFilesList);
				}
			}
			JSONObject pageJson = objectMapper.convertValue(detail, JSONObject.class);
			return R.data(VSTool.encrypt(encryptSign, pageJson.toJSONString(), VSTool.CHN));
		}else {
			return R.fail("Âä†ÂØÜËß£ÊûêÈîôËØØ");
		}
	}

	/**
	 * ÂÖ¨ÂÖ±ÊñπÊ≥ï-ÊâπÁ§∫/ÁïôË®Ä
	 * @param messageInformation
	 * @return
	 */
	@PostMapping("/saveMsgAndFile")
	@ApiOperationSupport(order = 3)
	@ApiOperation(value = "ÂÖ¨ÂÖ±ÊñπÊ≥ï-ÊâπÁ§∫/ÁïôË®Ä", notes = "‰º†ÂÖ•MessageInformationÂØπË±°")
	public R save(@Valid @RequestBody MessageInformation messageInformation) {
		User user = userClient.userInfoById(AuthUtil.getUserId()).getData();
		String userNameDecrypt = CryptoFactory.createCrypto(CryptoType.SM4).decrypt(user.getRealName());
		messageInformation.setAppriseUser(userNameDecrypt);
		messageInformation.setAppriseUserId(user.getId());
		String deptName = SysCache.getDeptName(Long.valueOf(user.getDeptId()));
		messageInformation.setAppriseuserDeptname(deptName);

		iMessageInformationService.save(messageInformation);

		if (messageInformation.getAppriseFilesList() != null) {
			List<AppriseFiles> appriseFilesList = messageInformation.getAppriseFilesList();
			//ÂêëÊñá‰ª∂‰ø°ÊÅØË°®‰∏≠‰øùÂ≠òÊï∞ÊçÆ
			for (AppriseFiles appriseFiles : appriseFilesList) {
				appriseFiles.setFileFrom("PCÁ´Ø");
				appriseFiles.setBusinessId(messageInformation.getId());
				appriseFiles.setUploadUserName(userNameDecrypt);
				iAppriseFilesService.save(appriseFiles);
			}
		}
		String title = "Êñ∞Â¢ûÊâπÁ§∫/ÁïôË®Ä";
		String businessId = String.valueOf(messageInformation.getId());
		String businessTable = "MessageInformation";
		int businessType = BusinessType.INSERT.ordinal();
		String[] businessIds = businessId.split(",");
		if (businessIds.length > 0) {
			for (int i = 0; i < businessIds.length; i++) {
				SpringUtil.getBean(IOperLogService.class).saveLog(title, businessIds[i], businessTable, businessType);
			}
		} else {
			SpringUtil.getBean(IOperLogService.class).saveLog(title, businessId, businessTable, businessType);
		}


		//TODO ÂêÑ‰∏™Ê®°ÂùóÂèëÈÄÅÊ∂àÊÅØ
		String receiveUser = messageInformation.getAppriseUserId()+",";//Êé•Êî∂‰∫∫
		boolean isLead = false;

		String roleId = sysClient.getRoleIds("000000", "Â∏ÇÁ∫ßÂõõÂ§ßÁè≠Â≠ê").getData().replace(",","");
		String[] roleIds = user.getRoleId().split(",");//Âà§Êñ≠ËØ•Áî®Êà∑ÊòØ‰∏çÊòØÂ∏ÇÁ∫ßÂõõÂ§ßÁè≠Â≠êÈ¢ÜÂØº
		for (String id : roleIds) {
			if (id.equals(roleId)) {
				isLead = true;
				break;
			}
		}
		if(isLead){//ËØ¥ÊòéÂΩìÂâçÁî®Êà∑ÊòØÂ∏ÇÁ∫ßÂõõÂ§ßÁè≠Â≠ê
			List<User> users = userClient.getUserListByRoleId(roleId).getData();
			for (User user1 : users) {
				if(!user.getId().equals(user1.getId())){
					receiveUser += user1.getId()+",";
				}
			}

			//ÂèëÈÄÅÁü≠‰ø°ÂºÄÂßã 20230516
			//Áù£Êü•Áù£ÂäûÊâπÁ§∫„ÄÅÁïôË®Ä
			if("1".equals(messageInformation.getBusinessType())){
				String mobiles = "";
					//Áù£Êü•Áù£ÂäûÈúÄË¶ÅÂèëÈÄÅÊ∂àÊÅØÁöÑÂØπË±°ÔºöÁâµÂ§¥Âçï‰Ωç„ÄÅÁù£Âäû‰∫∫„ÄÅËØÑ‰ª∑‰∫∫„ÄÅ‚Äú@‚ÄùÂØπË±°„ÄÇÔºàÂ¶ÇÊûúÁù£Âäû‰∫∫ÂíåËØÑ‰ª∑‰∫∫ÊòØÂêå‰∏ÄÊâãÊú∫Âè∑ÔºåÂè™Âèë‰∏ÄÊ¨°Ôºâ
				SupervisionInfo supervisionInfo = iSupervisionInfoService.getById(messageInformation.getBusinessId());
				//1„ÄÅÁâµÂ§¥Âçï‰Ωç
				String[] qtdwNames = supervisionInfo.getLeadUnitName().split(",");//‰∫ãÈ°πÁâµÂ§¥Âçï‰ΩçÂêçÁß∞
				for (String qtdwName : qtdwNames) {
					//Ê†πÊçÆÈÉ®Èó®ÂêçÁß∞Ëé∑ÂèñÁî®Êà∑
					List<User> userListDx1 = iUserSearchClient.getDeptUsers(qtdwName).getData();
					if(userListDx1 != null && userListDx1.size() > 0){
						for(User userDx1 : userListDx1){
							mobiles += userDx1.getPhone()+",";
						}
					}
				}
				//2„ÄÅÁù£Âäû‰∫∫Ôºà‰∏Ä‰∏™Ôºâ
				String supervisor = supervisionInfo.getSupervisorName();
				//Ê†πÊçÆÈÉ®Èó®ÂêçÁß∞Ëé∑ÂèñÁî®Êà∑
				List<User> userListDx2 = iUserSearchClient.getDeptUsers(supervisor).getData();
				if(userListDx2 != null && userListDx2.size() > 0){
					for(User userDx2 : userListDx2){
						if(!mobiles.contains(userDx2.getPhone())){  //ÂéªÈô§ÈáçÂ§çÊâãÊú∫Âè∑
							mobiles += userDx2.getPhone()+",";
						}
					}
				}

				//3„ÄÅËØÑ‰ª∑‰∫∫Ôºà‰∏Ä‰∏™Ôºâ
				String evaluator = supervisionInfo.getEvaluatorName();
				//Ê†πÊçÆÈÉ®Èó®ÂêçÁß∞Ëé∑ÂèñÁî®Êà∑
				List<User> userListDx3 = iUserSearchClient.getDeptUsers(evaluator).getData();
				if(userListDx3 != null && userListDx3.size() > 0){
					for(User userDx3 : userListDx3){
						if(!mobiles.contains(userDx3.getPhone())){  //ÂéªÈô§ÈáçÂ§çÊâãÊú∫Âè∑
							mobiles += userDx3.getPhone()+",";
						}
					}
				}

				//4„ÄÅ@ÂØπË±°
				String atUserId = messageInformation.getAtUserId();
				if(StringUtil.isNotBlank(atUserId)){
					String[] userIdsDx4 = messageInformation.getAtUserId().split(",");
					for (String userIdDx4 : userIdsDx4) {
						List<User> userListDx4 = iUserSearchClient.listByUser(userIdDx4).getData();
						if(!mobiles.contains(userListDx4.get(0).getPhone())) {
							mobiles += userListDx4.get(0).getPhone();
						}
					}
				}
				log.info("Áù£ÂØüÁù£ÂäûÊâÄÊúâÈúÄË¶ÅÂèëÁü≠‰ø°ÁöÑÂè∑Á†ÅÔºö"+mobiles);
				if(StringUtil.isNotBlank(mobiles)){
					mobiles = mobiles.substring(0, mobiles.length() - 1);
					String content = "ÊÇ®Êúâ‰∏ÄÊù°È¢ÜÂØºÊâπÁ§∫ÔºåËØ∑ÁôªÂΩïÁù£ËÄÉ‰∏Ä‰ΩìÂåñÂπ≥Âè∞ËøõË°åÊü•Áúã„ÄÇ";
					smsDockingService.send(mobiles,content);
				}
			}
			//È°πÁõÆÁÆ°ÁêÜÊâπÁ§∫„ÄÅÁïôË®Ä
			if("3".equals(messageInformation.getBusinessType())){
				String mobiles = "";
				ProjectSummary projectSummary = projectSummaryService.getById(messageInformation.getBusinessId());
				//1„ÄÅÂ∏ÇÁõ¥Ë°å‰∏ö‰∏ªÁÆ°ÈÉ®Èó®
				String[] szhyzgbmNames = projectSummary.getSzhyzgbmName().split(",");
				for (String szhyzgbmName : szhyzgbmNames) {
					//Ê†πÊçÆÈÉ®Èó®ÂêçÁß∞Ëé∑ÂèñÁî®Êà∑
					List<User> userListXm1 = iUserSearchClient.getDeptUsers(szhyzgbmName).getData();
					if(userListXm1 != null && userListXm1.size() > 0){
						for(User userXm1 : userListXm1){
							mobiles += userXm1.getPhone()+",";
						}
					}
				}
				//2„ÄÅÂéøÁ∫ßÂåÖÊäìÈ¢ÜÂØº
				String[] xjbzlds = projectSummary.getXjbzld().split(",");
				for (String xjbzld : xjbzlds) {
					List<User> userListXm2 = iUserSearchClient.listByUser(xjbzld).getData();
					if(userListXm2 != null && userListXm2.size() > 0){
						for(User userXm2 : userListXm2){
							mobiles += userXm2.getPhone()+",";
						}
					}
				}
				//3„ÄÅË∞ÉÂ∫¶Âçï‰Ωç
				String[] dwmcNames = projectSummary.getDwmcName().split(",");
				for (String dwmcName : dwmcNames) {
					//Ê†πÊçÆÈÉ®Èó®ÂêçÁß∞Ëé∑ÂèñÁî®Êà∑
					List<User> userListXm3 = iUserSearchClient.getDeptUsers(dwmcName).getData();
					if(userListXm3 != null && userListXm3.size() > 0){
						for(User userXm3 : userListXm3){
							mobiles += userXm3.getPhone()+",";
						}
					}
				}
				//4„ÄÅ@ÂØπË±°
				String atUerId = messageInformation.getAtUserId();
				if(StringUtil.isNotBlank(atUerId)){
					String[] userIdsDx4 = atUerId.split(",");
					for (String userIdDx4 : userIdsDx4) {
						List<User> userListDx4 = iUserSearchClient.listByUser(userIdDx4).getData();
						if(!mobiles.contains(userListDx4.get(0).getPhone())) {
							mobiles += userListDx4.get(0).getPhone();
						}
					}
				}
				log.info("Áù£ÂØüÁù£ÂäûÊâÄÊúâÈúÄË¶ÅÂèëÁü≠‰ø°ÁöÑÂè∑Á†ÅÔºö"+mobiles);
				if(StringUtil.isNotBlank(mobiles)){
					mobiles = mobiles.substring(0, mobiles.length() - 1);
					String content = "ÊÇ®Êúâ‰∏ÄÊù°È¢ÜÂØºÊâπÁ§∫ÔºåËØ∑ÁôªÂΩïÁù£ËÄÉ‰∏Ä‰ΩìÂåñÂπ≥Âè∞ËøõË°åÊü•Áúã„ÄÇ";
					smsDockingService.send(mobiles,content);
				}
			}
			//ÂèëÈÄÅÁü≠‰ø°ÁªìÊùü 20230516
		}
		String authPostId = sysClient.getPostIdsByFuzzy("000000","ÁÆ°ÁêÜÂëò").getData();//Ëé∑ÂèñÁÆ°ÁêÜÂëòÂ≤ó‰Ωçid
		String leadPostId = sysClient.getPostIdsByFuzzy("000000","ÈÉ®Èó®È¢ÜÂØº").getData();//Ëé∑ÂèñÈ¢ÜÂØºÂ≤ó‰Ωçid

		if("3".equals(messageInformation.getBusinessType())){//È°πÁõÆÁÆ°ÁêÜÊâπÁ§∫/ÁïôË®Ä
			ProjectSummary projectSummary = projectSummaryService.getById(messageInformation.getBusinessId());
			if(isLead){
				//Â∏ÇÂßîÂäûÂÖ¨ÂÆ§„ÄÅÂ∏ÇÊîøÂ∫úÂäûÂÖ¨ÂÆ§„ÄÅÂ∏ÇÂèëÊîπÂßî
				String deptId1 = sysClient.getDeptIdsByFuzzy("000000","Â∏ÇÂßîÂäûÂÖ¨ÂÆ§").getData();
				String deptId2 = sysClient.getDeptIdsByFuzzy("000000","Â∏ÇÊîøÂ∫úÂäûÂÖ¨ÂÆ§").getData();
				String deptId3 = sysClient.getDeptIdsByFuzzy("000000","Â∏ÇÂèëÂ±ïÊîπÈù©Âßî").getData();
				List<User> users= iUserSearchClient.listByPostAndDept(leadPostId,deptId1).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÈ¢ÜÂØºÁî®Êà∑
				users.addAll(iUserSearchClient.listByPostAndDept(leadPostId,deptId2).getData());
				users.addAll(iUserSearchClient.listByPostAndDept(leadPostId,deptId3).getData());
				users.addAll(iUserSearchClient.listByPostAndDept(authPostId,deptId1).getData());
				users.addAll(iUserSearchClient.listByPostAndDept(authPostId,deptId2).getData());
				users.addAll(iUserSearchClient.listByPostAndDept(authPostId,deptId3).getData());
				//Â∏ÇÂèëÊîπÂßîÊäïËµÑÁßë
				receiveUser += PropConstant.getProjectShzhId("6207")+",";
				//Â∏ÇÁ∫ßË°å‰∏ö‰∏ªÁÆ°ÈÉ®Èó®
				String deptId4 = projectSummary.getSzhyzgbm();
				if(StringUtil.isNotBlank(deptId4)){
					users.addAll(iUserSearchClient.listByPostAndDept(leadPostId,deptId4).getData());
					users.addAll(iUserSearchClient.listByPostAndDept(authPostId,deptId4).getData());
				}
				//Ë∞ÉÂ∫¶Âçï‰Ωç
				String deptId5 = projectSummary.getDwmc();
				if(StringUtil.isNotBlank(deptId5)){
					users.addAll(iUserSearchClient.listByPostAndDept(leadPostId,deptId5).getData());
					users.addAll(iUserSearchClient.listByPostAndDept(authPostId,deptId5).getData());
				}
				//Â∏ÇÁ∫ßÂåÖÊäìÈ¢ÜÂØº
				String sjbzld = projectSummary.getSjbzld();
				if(StringUtil.isNotBlank(sjbzld)){
					receiveUser += sjbzld+",";
				}
				//Â¶ÇÊûú‰∏çÊòØÂ∏ÇÁ∫ßÈ°πÁõÆ
				if(!"6207".equals(projectSummary.getAreaCode())){
					//ÂéøÁ∫ßÂõõÂ§ßÁè≠Â≠ê
					String roleIdXj = sysClient.getRoleIds("000000", "ÂéøÁ∫ßÂõõÂ§ßÁè≠Â≠ê").getData().replace(",","");
					users.addAll(userClient.getUserListByRoleId(roleId).getData());
					//ÂéøÁ∫ßÂèëÊîπÂ±Ä
					receiveUser += PropConstant.getProjectShzhId(projectSummary.getAreaCode())+",";
					//ÂéøÂèëÊîπÂ±ÄÈ¢ÜÂØº
					User u = userClient.userInfoById(Long.parseLong(PropConstant.getProjectShzhId(projectSummary.getAreaCode()))).getData();
					if(u != null && StringUtil.isNotBlank(u.getDeptId())){
						users.addAll(iUserSearchClient.listByPostAndDept(leadPostId,u.getDeptId()).getData());
						users.addAll(iUserSearchClient.listByPostAndDept(authPostId,u.getDeptId()).getData());
					}
					//ÂéøÁ∫ßË°å‰∏ö‰∏ªÁÆ°ÈÉ®Èó®
					String deptId6 = projectSummary.getXqhyzgbm();
					if(StringUtil.isNotBlank(deptId6)){
						users.addAll(iUserSearchClient.listByPostAndDept(leadPostId,deptId6).getData());
						users.addAll(iUserSearchClient.listByPostAndDept(authPostId,deptId6).getData());
					}
				}
				for (User user1 : users) {
					if(!user.getId().equals(user1.getId())){
						receiveUser += user1.getId()+",";
					}
				}
			}
//			receiveUser += projectSummaryService.getUserIdListByProjId(projectSummary.getId(),AuthUtil.getUserId());
			String userIds= projectSummaryService.getUserIdListByProjId(projectSummary.getId(),AuthUtil.getUserId());//È°πÁõÆÂÜÖÁöÑ‰∫∫Âëò
			receiveUser += receiveUser + userIds;

			receiveUser += projectSummary.getCreateUser().toString()+",";
			String content = "„Äê"+userNameDecrypt+"„ÄëÂØπ„Äê"+projectSummary.getTitle()+"„ÄëËøõË°å‰∫ÜÁïôË®Ä/ÊâπÁ§∫";
			String appMsgType = "34";

			UnifyMessage message = new UnifyMessage();
			message.setMsgId(projectSummary.getId());
			message.setMsgTitle("È°πÁõÆÁÆ°ÁêÜÁïôË®Ä/ÊâπÁ§∫");
			message.setMsgType(appMsgType);
			message.setMsgStatus(0);
			message.setMsgPlatform("web");
			message.setMsgIntro(content);
			message.setTwoLevelType(appMsgType);
			message.setCreateTime(new Date());
			message.setMsgSubitem("È°πÁõÆÁÆ°ÁêÜ");
			message.setReceiveUser(StringUtils.isNotEmpty(messageInformation.getAtUserId())?messageInformation.getAtUserId()+","+AuthUtil.getUserId():quchong(receiveUser));//Êé•Êî∂‰∫∫ÂéªÈáç
			messageService.sendMessageInfo(message);

			message.setId(null);
			message.setMsgType("11");
			message.setMsgPlatform("app");
			messageService.sendMessageInfo(message);

			ProjectLog projectLog = new ProjectLog();//È°πÁõÆÊó•Âøó
			projectLog.setProjId(projectSummary.getId());
			projectLog.setHandleType("È°πÁõÆÊâπÁ§∫");
			projectLog.setHandleUser(userNameDecrypt);
			projectLog.setHandleDept(sysClient.getDept(Long.parseLong(user.getDeptId())).getData().getDeptName());
			String handleUserDecrypt = CryptoFactory.createCrypto(CryptoType.SM4).decrypt(projectLog.getHandleUser());
			projectLog.setHandleContent("„Äê"+handleUserDecrypt+"„ÄëÂØπ„Äê"+projectSummary.getTitle()+"„ÄëËøõË°å‰∫ÜÁïôË®Ä/ÊâπÁ§∫");
			projectLogService.save(projectLog);
		}else if("1".equals(messageInformation.getBusinessType())){//Áù£ÂØüÁù£ÂäûÊâπÁ§∫/ÁïôË®Ä
			SupervisionInfo supervisionInfo = iSupervisionInfoService.getById(messageInformation.getBusinessId());

			receiveUser += supervisionInfo.getCreateUser()+",";//‰∫ãÈ°π‰∏ãÂèëÂçï‰Ωç
			if(isLead){//Â¶ÇÊûúÂΩìÂâçÁî®Êà∑ÊòØÂõõÂ§ßÁè≠Â≠êÈ¢ÜÂØº
				String deptId = supervisionInfo.getCreateDept().toString();
				List<User> users= iUserSearchClient.listByPostAndDept(authPostId,deptId).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÁÆ°ÁêÜÂëòÁî®Êà∑
				if(users!=null){
					for(User u : users){
						receiveUser += u.getId()+",";
					}
				}

				users= iUserSearchClient.listByPostAndDept(leadPostId,deptId).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÈ¢ÜÂØºÁî®Êà∑
				if(users!=null){
					for(User u : users){
						receiveUser += u.getId()+",";
					}
				}

				users = userClient.getUserListByDeptId(deptId).getData();//Ëé∑ÂèñËØ•Âçï‰ΩçÊâÄÊúâÂàÜÁÆ°È¢ÜÂØº
				if(users!=null){
					for(User u : users){
						receiveUser += u.getId()+",";
					}
				}
			}
			String[] ids1 = supervisionInfo.getLeadUnit().split(",");//‰∫ãÈ°πÁâµÂ§¥Âçï‰Ωç
			for (String id : ids1) {
				List<User> users= iUserSearchClient.listByPostAndDept(authPostId,id).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÁÆ°ÁêÜÂëòÁî®Êà∑
				if(users!=null){
					for(User u : users){
						receiveUser += u.getId()+",";
					}
				}

				if(isLead){//Â¶ÇÊûúÂΩìÂâçÁî®Êà∑ÊòØÂõõÂ§ßÁè≠Â≠êÈ¢ÜÂØº
					users= iUserSearchClient.listByPostAndDept(leadPostId,id).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÈ¢ÜÂØºÁî®Êà∑
					if(users!=null){
						for(User u : users){
							receiveUser += u.getId()+",";
						}
					}

					users = userClient.getUserListByDeptId(id).getData();//Ëé∑ÂèñËØ•Âçï‰ΩçÊâÄÊúâÂàÜÁÆ°È¢ÜÂØº
					if(users!=null){
						for(User u : users){
							receiveUser += u.getId()+",";
						}
					}
				}
			}
			String[] ids2 = supervisionInfo.getDutyUnit().split(",");//‰∫ãÈ°πË¥£‰ªªÂçï‰Ωç
			for (String id : ids2) {
				List<User> users= iUserSearchClient.listByPostAndDept(authPostId,id).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÁÆ°ÁêÜÂëòÁî®Êà∑
				if(users!=null){
					for(User u : users){
						receiveUser += u.getId()+",";
					}
				}

				if(isLead){//Â¶ÇÊûúÂΩìÂâçÁî®Êà∑ÊòØÂõõÂ§ßÁè≠Â≠êÈ¢ÜÂØº
					users= iUserSearchClient.listByPostAndDept(leadPostId,id).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÈ¢ÜÂØºÁî®Êà∑
					if(users!=null){
						for(User u : users){
							receiveUser += u.getId()+",";
						}
					}

					users = userClient.getUserListByDeptId(id).getData();//Ëé∑ÂèñËØ•Âçï‰ΩçÊâÄÊúâÂàÜÁÆ°È¢ÜÂØº
					if(users!=null){
						for(User u : users){
							receiveUser += u.getId()+",";
						}
					}
				}
			}

			String content = "„Äê"+userNameDecrypt+"„ÄëÂØπ„Äê"+supervisionInfo.getServName()+"„ÄëËøõË°å‰∫ÜÁïôË®Ä/ÊâπÁ§∫";
			String msgType = "41";
			String appMsgType = "42";

			UnifyMessage message = new UnifyMessage();
			message.setMsgId(supervisionInfo.getId());
			message.setMsgTitle("Áù£Êü•Áù£ÂäûÁïôË®Ä/ÊâπÁ§∫");
			message.setMsgType(msgType);
			message.setMsgStatus(0);
			message.setMsgPlatform("web");
			message.setMsgIntro(content);
			message.setCreateTime(new Date());

			//ÂÖ≥‰∫é@ÂèëÈÄÅÊ∂àÊÅØ
			message.setReceiveUser(StringUtils.isNotEmpty(messageInformation.getAtUserId())?messageInformation.getAtUserId()+","+AuthUtil.getUserId():quchong(receiveUser));//Êé•Êî∂‰∫∫ÂéªÈáç
			messageService.sendMessageInfo(message);

			String value = dictBizClient.getValue(supervisionInfo.getServTypeOne(), supervisionInfo.getServTypeTwo()).getData();
			message.setId(null);
			message.setMsgPlatform("app");
			message.setMsgType(Constants.MSG_TYPE_APP_ONE_PSLY);
			message.setMsgSubitem(value);
			message.setTwoLevelType(appMsgType);
			messageService.sendMessageInfo(message);

			SupervisionLog log = new SupervisionLog();
			log.setServCode(supervisionInfo.getServCode());
			log.setOperationDept(user.getDeptId());
			log.setOperationDeptName(sysClient.getDeptName(Long.parseLong(user.getDeptId())).getData());
			log.setOperationUser(user.getId().toString());
			log.setOperationUserName(userNameDecrypt);
			log.setOperationType("8");
			log.setOperationTime(new Date());
			log.setContent("„Äê"+userNameDecrypt+"„ÄëÂØπ„Äê"+supervisionInfo.getServName()+"„ÄëËøõË°åÁïôË®Ä/ÊâπÁ§∫");
			supervisionLogService.save(log);
		}else if("2".equals(messageInformation.getBusinessType())){//ËÄÉÊ†∏ËØÑ‰ª∑
			//ÂèëÈÄÅÊ∂àÊÅØ
			AnnualEvaluation ae = annualEvaluationService.getById(messageInformation.getBusinessId());
			QuarterlyEvaluation qe = quarterlyEvaluationService.getById(messageInformation.getBusinessId());
			if(ae!=null){//Âπ¥Â∫¶ËØÑ‰ª∑
				String msgSubmit=dictBizClient.getValue("ndkp-type",ae.getType()).getData();
				String msgIntro = "„Äê"+userNameDecrypt+"„ÄëÂØπÂπ¥Â∫¶ËØÑ‰ª∑ÊåáÊ†áÔºö„Äê"+ae.getMajorTarget()+"„ÄëËøõË°åÁïôË®Ä/ÊâπÁ§∫";
				Long deptId=ae.getCreateDept();//ÊåáÊ†áÂàõÂª∫Âçï‰Ωç‰∏ãÈù¢ÁöÑÁõ∏ÂÖ≥‰∫∫Âëò‰πüË¶ÅÂèëÈÄÅ
				String[] ids = ae.getAppraiseObjectId().split(",");//ËÄÉÊ†∏ÂØπË±°Âçï‰Ωçids
				ArrayList<String> ids1List = new ArrayList<String>(Arrays.asList(ids));
				ids1List.add(deptId.toString());
				String[] ids1 = (String[]) ids1List.toArray(new String[0]);
				String[] ids2 = ae.getAppraiseDeptid().split(",");

				for (String id : ids1) {
						List<User> users= iUserSearchClient.listByPostAndDept(authPostId,id).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÁÆ°ÁêÜÂëòÁî®Êà∑
						if(users!=null){
							for(User u : users){
								receiveUser += u.getId()+",";
							}
						}
						if(isLead){
							users= iUserSearchClient.listByPostAndDept(leadPostId,id).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÈ¢ÜÂØºÁî®Êà∑
							if(users!=null){
								for(User u : users){
									receiveUser += u.getId()+",";
								}
							}
							users = userClient.getUserListByDeptId(id).getData();//Ëé∑ÂèñËØ•Âçï‰ΩçÊâÄÊúâÂàÜÁÆ°È¢ÜÂØº
							if(users!=null){
								for(User u : users){
									receiveUser += u.getId()+",";
								}
							}

						}
					}
					for (String id : ids2) {
						List<User> users= iUserSearchClient.listByPostAndDept(authPostId,id).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÁÆ°ÁêÜÂëòÁî®Êà∑
						if(users!=null){
							for(User u : users){
								receiveUser += u.getId()+",";
							}
						}
						if(isLead){
							users= iUserSearchClient.listByPostAndDept(leadPostId,id).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÈ¢ÜÂØºÁî®Êà∑
							if(users!=null){
								for(User u : users){
									receiveUser += u.getId()+",";
								}
							}
							users = userClient.getUserListByDeptId(id).getData();//Ëé∑ÂèñËØ•Âçï‰ΩçÊâÄÊúâÂàÜÁÆ°È¢ÜÂØº
							if(users!=null){
								for(User u : users){
									receiveUser += u.getId()+",";
								}
							}
					}
				}
				UnifyMessage message = new UnifyMessage();
				message.setMsgId(Long.valueOf(messageInformation.getBusinessId()));//Ê∂àÊÅØ‰∏ªÈîÆÔºà‰∏öÂä°‰∏ªÈîÆÔºâ
				message.setMsgTitle("Âπ¥Â∫¶ËØÑ‰ª∑ÊâπÁ§∫/ÁïôË®Ä");//Ê∂àÊÅØÊ†áÈ¢ò
				message.setMsgType("43");//Ê∂àÊÅØÁ±ªÂûãÔºåÂ≠óÂÖ∏ÁºñÁ†ÅÔºöweb_message_type
				message.setMsgPlatform("web");//Âπ≥Âè∞ÔºöwebÊàñapp
				message.setReceiveUser(StringUtils.isNotEmpty(messageInformation.getAtUserId())?messageInformation.getAtUserId()+","+AuthUtil.getUserId():quchong(receiveUser));
				message.setMsgIntro(msgIntro);//Ê∂àÊÅØÁÆÄ‰ªã
				message.setMsgSubitem(msgSubmit);//Ê∂àÊÅØÂàÜÈ°π
				message.setMsgStatus(StatusConstant.UNIFY_MESSAGE_0);
				message.setCreateTime(new Date());
				messageService.sendMessageInfo(message);

				message.setId(null);
				message.setMsgPlatform("app");
				message.setMsgType(Constants.MSG_TYPE_APP_ONE_PSLY);
				message.setTwoLevelType("46");//Âπ¥Â∫¶ÊâπÁ§∫ÁïôË®Ä
				messageService.sendMessageInfo(message);
			}else if(qe!=null){//Â≠£Â∫¶ËØÑ‰ª∑
				//ÂèëÈÄÅÊ∂àÊÅØ
				String msgSubmit=dictBizClient.getValue("jdpj-type",qe.getJdzbType()).getData();
				String msgIntro="";
				if (qe.getMajorTarget() != null && qe.getMajorTarget()!="") {
					msgIntro = "„Äê"+userNameDecrypt+"„ÄëÂØπÂ≠£Â∫¶ËØÑ‰ª∑ÊåáÊ†áÔºö„Äê"+qe.getMajorTarget()+"„ÄëËøõË°åÁïôË®Ä/ÊâπÁ§∫";
				}else if (qe.getFirstTarget() != null && qe.getFirstTarget()!="") {
					msgIntro = "„Äê"+userNameDecrypt+"„ÄëÂØπÂ≠£Â∫¶ËØÑ‰ª∑ÊåáÊ†áÔºö„Äê"+qe.getFirstTarget()+"„ÄëËøõË°åÁïôË®Ä/ÊâπÁ§∫";
				} else if (qe.getTwoTarget() != null && qe.getTwoTarget()!="") {
					msgIntro = "„Äê"+userNameDecrypt+"„ÄëÂØπÂ≠£Â∫¶ËØÑ‰ª∑ÊåáÊ†áÔºö„Äê"+qe.getTwoTarget()+"„ÄëËøõË°åÁïôË®Ä/ÊâπÁ§∫";
				}else if (qe.getImportWork()!= null && qe.getImportWork()!="") {
					msgIntro = "„Äê"+userNameDecrypt+"„ÄëÂØπÂ≠£Â∫¶ËØÑ‰ª∑ÊåáÊ†áÔºö„Äê"+qe.getImportWork()+"„ÄëËøõË°åÁïôË®Ä/ÊâπÁ§∫";
				} else {
					msgIntro = "„Äê"+userNameDecrypt+"„ÄëÂØπÂ≠£Â∫¶ËØÑ‰ª∑ÊåáÊ†áËøõË°åÁïôË®Ä/ÊâπÁ§∫";
				}

				Long deptId=qe.getCreateDept();//ÊåáÊ†áÂàõÂª∫Âçï‰Ωç‰∏ãÈù¢ÁöÑÁõ∏ÂÖ≥‰∫∫Âëò‰πüË¶ÅÂèëÈÄÅ
				String[] ids = qe.getCheckObjectId().split(",");//ËÄÉÊ†∏ÂØπË±°Âçï‰Ωçid
				ArrayList<String> ids1List = new ArrayList<String>(Arrays.asList(ids));
				ids1List.add(deptId.toString());
				String[] ids1 = (String[]) ids1List.toArray(new String[0]);
				for (String id : ids1) {
						List<User> users= iUserSearchClient.listByPostAndDept(authPostId,id).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÁÆ°ÁêÜÂëòÁî®Êà∑
						if(users!=null){
							for(User u : users){
								receiveUser += u.getId()+",";
							}
						}
						if(isLead){
							users= iUserSearchClient.listByPostAndDept(leadPostId,id).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÈ¢ÜÂØºÁî®Êà∑
							if(users!=null){
								for(User u : users){
									receiveUser += u.getId()+",";
								}
							}
							users = userClient.getUserListByDeptId(id).getData();//Ëé∑ÂèñËØ•Âçï‰ΩçÊâÄÊúâÂàÜÁÆ°È¢ÜÂØº
							if(users!=null){
								for(User u : users){
									receiveUser += u.getId()+",";
								}
							}
						}
				}
				String[] ids2 = qe.getAppraiseDeptid().split(",");
				for (String id : ids2) {
					List<User> users= iUserSearchClient.listByPostAndDept(authPostId,id).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÁÆ°ÁêÜÂëòÁî®Êà∑
					if(users!=null){
						for(User u : users){
							receiveUser += u.getId()+",";
						}
					}
					if(isLead){
						users= iUserSearchClient.listByPostAndDept(leadPostId,id).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÈ¢ÜÂØºÁî®Êà∑
						if(users!=null){
							for(User u : users){
								receiveUser += u.getId()+",";
							}
						}
						users = userClient.getUserListByDeptId(id).getData();//Ëé∑ÂèñËØ•Âçï‰ΩçÊâÄÊúâÂàÜÁÆ°È¢ÜÂØº
						if(users!=null){
							for(User u : users){
								receiveUser += u.getId()+",";
							}
						}
					}
				}

				UnifyMessage message = new UnifyMessage();
				message.setMsgId(Long.valueOf(messageInformation.getBusinessId()));//Ê∂àÊÅØ‰∏ªÈîÆÔºà‰∏öÂä°‰∏ªÈîÆÔºâ
				message.setMsgTitle("Â≠£Â∫¶ËØÑ‰ª∑ÊâπÁ§∫/ÁïôË®Ä");//Ê∂àÊÅØÊ†áÈ¢ò
				message.setMsgType("44");//Ê∂àÊÅØÁ±ªÂûãÔºåÂ≠óÂÖ∏ÁºñÁ†ÅÔºöweb_message_type
				message.setMsgPlatform("web");//Âπ≥Âè∞ÔºöwebÊàñapp
				message.setReceiveUser(StringUtils.isNotEmpty(messageInformation.getAtUserId())?messageInformation.getAtUserId()+","+AuthUtil.getUserId():quchong(receiveUser));//Êé•Êî∂‰∫∫ÂéªÈáç
				message.setMsgIntro(msgIntro);//Ê∂àÊÅØÁÆÄ‰ªã
				message.setMsgSubitem(msgSubmit);//Ê∂àÊÅØÂàÜÈ°π
				message.setMsgStatus(StatusConstant.UNIFY_MESSAGE_0);
				message.setCreateTime(new Date());
				messageService.sendMessageInfo(message);

				message.setId(null);
				message.setMsgPlatform("app");
				message.setMsgType(Constants.MSG_TYPE_APP_ONE_PSLY);
				message.setTwoLevelType("47");//Â≠£Â∫¶ÊâπÁ§∫ÁïôË®Ä
				messageService.sendMessageInfo(message);
			}
		}else if("4".equals(messageInformation.getBusinessType())){//Áª©ÊïàËÄÉÊ†∏-È¢ÜÂØºËØÑ‰ª∑
			Long  leaderAppriseId= messageInformation.getBusinessId();
			//Ëé∑ÂèñÈ¢ÜÂØºËØÑ‰ª∑ÂØπË±°
			LeaderApprise la =leaderAppriseService.getById(leaderAppriseId);
			//ÁªôÈ¢ÜÂØºËØÑ‰ª∑ÂàõÂª∫‰∫∫ÂèëÊ∂àÊÅØ
			Long createDept = la.getCreateDept();
			List<User> createDeptUsers= iUserSearchClient.listByPostAndDept(authPostId, String.valueOf(createDept)).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÁÆ°ÁêÜÂëòÁî®Êà∑
			if(createDeptUsers!=null){
				for(User u : createDeptUsers){
					receiveUser += u.getId()+",";
				}
			}
			//ÁªôËØÑ‰ª∑Âçï‰ΩçÂèëÊ∂àÊÅØ
			List<User> users= iUserSearchClient.listByPostAndDept(authPostId,la.getDeptId()).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÁÆ°ÁêÜÂëòÁî®Êà∑
			if(users!=null){
				for(User u : users){
					receiveUser += u.getId()+",";
				}
			}
			//ÂõõÂ§ßÁè≠Â≠êÁªô‰∏ãÈù¢È¢ÜÂØºÂèëÊ∂àÊÅØ
			if(isLead){
				users= iUserSearchClient.listByPostAndDept(leadPostId,la.getDeptId()).getData();//Ëé∑ÂèñË¥£‰ªªÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÈ¢ÜÂØºÁî®Êà∑
				if(users!=null){
					for(User u : users){
						receiveUser += u.getId()+",";
					}
				}
				users = userClient.getUserListByDeptId(la.getDeptId()).getData();//Ëé∑ÂèñËØ•Ë¥£‰ªªÂçï‰ΩçÊâÄÊúâÂàÜÁÆ°È¢ÜÂØº
				if(users!=null){
					for(User u : users){
						receiveUser += u.getId()+",";
					}
				}

				users= iUserSearchClient.listByPostAndDept(leadPostId, String.valueOf(createDept)).getData();//Ëé∑ÂèñÂàõÂª∫Âçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÈ¢ÜÂØºÁî®Êà∑
				if(users!=null){
					for(User u : users){
						receiveUser += u.getId()+",";
					}
				}
				users = userClient.getUserListByDeptId(String.valueOf(createDept)).getData();//Ëé∑ÂèñÂàõÂª∫Âçï‰ΩçÊâÄÊúâÂàÜÁÆ°È¢ÜÂØº
				if(users!=null){
					for(User u : users){
						receiveUser += u.getId()+",";
					}
				}
			}
			//ÂèëÈÄÅÊ∂àÊÅØ
			String content = "„Äê"+userNameDecrypt+"„ÄëÈ¢ÜÂØºÂØπ„Äê"+la.getDeptName()+"„ÄëËøõË°å‰∫ÜÈ¢ÜÂØºËØÑ‰ª∑ÁïôË®Ä/ÊâπÁ§∫";
			UnifyMessage message = new UnifyMessage();
			message.setMsgId(Long.valueOf(la.getId()));//Ê∂àÊÅØ‰∏ªÈîÆÔºà‰∏öÂä°‰∏ªÈîÆÔºâ
			message.setMsgTitle("È¢ÜÂØºËØÑ‰ª∑");//Ê∂àÊÅØÊ†áÈ¢ò
			message.setMsgType("48");//Ê∂àÊÅØÁ±ªÂûãÔºåÂ≠óÂÖ∏ÁºñÁ†ÅÔºöweb_message_type
			message.setMsgPlatform("web");//Âπ≥Âè∞ÔºöwebÊàñapp
			message.setReceiveUser(StringUtils.isNotEmpty(messageInformation.getAtUserId())?messageInformation.getAtUserId()+","+AuthUtil.getUserId():quchong(receiveUser));
			message.setMsgIntro(content);//Ê∂àÊÅØÁÆÄ‰ªã
			message.setMsgSubitem("È¢ÜÂØºËØÑ‰ª∑");//Ê∂àÊÅØÂàÜÈ°π
			message.setMsgStatus(StatusConstant.UNIFY_MESSAGE_0);
			message.setCreateTime(new Date());
			messageService.sendMessageInfo(message);

			message.setId(null);
			message.setMsgPlatform("app");
			message.setMsgType(Constants.MSG_TYPE_APP_ONE_PSLY);
			message.setTwoLevelType("50");//È¢ÜÂØºËØÑ‰ª∑
			messageService.sendMessageInfo(message);
		}
		return R.success("Êìç‰ΩúÊàêÂäüÔºÅ");
	}

	/**
	 * ÂÖ¨ÂÖ±ÊñπÊ≥ï-ÊâπÁ§∫/ÁïôË®Ä-app
	 */
	@PostMapping("/saveMsgAndFileApp")
	@ApiOperationSupport(order = 3)
	@ApiOperation(value = "ÂÖ¨ÂÖ±ÊñπÊ≥ï-ÊâπÁ§∫/ÁïôË®Ä", notes = "‰º†ÂÖ•MessageInformationÂØπË±°")
	public R saveMsgAndFileApp(@RequestBody Map<String, Object> map) {
		//ÂèÇÊï∞Ëß£ÂØÜ
		String params = map.get("params").toString();
		//1„ÄÅÊó•ÂøóËÆ∞ÂΩï
		bladeLogger.info("ÂÖ¨ÂÖ±ÊñπÊ≥ï-ÊâπÁ§∫/ÁïôË®Ä-app",params);
		//2„ÄÅÂèÇÊï∞Ëß£ÂØÜ
		Map<String, Object> dataMap = VSTool.decrypt(httpSafeConstant.getPrivateKey(), params, VSTool.CHN);
		String encryptSign;
		JSONObject jsonParams;
		if (dataMap.get("extra") != null) {
			encryptSign = dataMap.get("sign").toString();
			jsonParams = JSONObject.parseObject(dataMap.get("extra").toString());
		}else{
			return R.fail("Âä†ÂØÜËß£ÊûêÈîôËØØ");
		}
		MessageInformation messageInformation = objectMapper.convertValue(jsonParams, MessageInformation.class);
		User user = userClient.userInfoById(AuthUtil.getUserId()).getData();
		String userNameDecrypt = CryptoFactory.createCrypto(CryptoType.SM4).decrypt(user.getRealName());
		messageInformation.setAppriseUser(userNameDecrypt);
		messageInformation.setAppriseUserId(user.getId());
		String deptName = SysCache.getDeptName(Long.valueOf(user.getDeptId()));
		messageInformation.setAppriseuserDeptname(deptName);

		iMessageInformationService.save(messageInformation);

		if (messageInformation.getAppriseFilesList() != null) {
			List<AppriseFiles> appriseFilesList = messageInformation.getAppriseFilesList();
			//ÂêëÊñá‰ª∂‰ø°ÊÅØË°®‰∏≠‰øùÂ≠òÊï∞ÊçÆ
			for (AppriseFiles appriseFiles : appriseFilesList) {
				appriseFiles.setFileFrom("PCÁ´Ø");
				appriseFiles.setBusinessId(messageInformation.getId());
				appriseFiles.setUploadUserName(userNameDecrypt);
				iAppriseFilesService.save(appriseFiles);
			}
		}
		String title = "Êñ∞Â¢ûÊâπÁ§∫/ÁïôË®Ä";
		String businessId = String.valueOf(messageInformation.getId());
		String businessTable = "MessageInformation";
		int businessType = BusinessType.INSERT.ordinal();
		String[] businessIds = businessId.split(",");
		if (businessIds.length > 0) {
			for (int i = 0; i < businessIds.length; i++) {
				SpringUtil.getBean(IOperLogService.class).saveLog(title, businessIds[i], businessTable, businessType);
			}
		} else {
			SpringUtil.getBean(IOperLogService.class).saveLog(title, businessId, businessTable, businessType);
		}


		//TODO ÂêÑ‰∏™Ê®°ÂùóÂèëÈÄÅÊ∂àÊÅØ
		String receiveUser = messageInformation.getAppriseUserId()+",";//Êé•Êî∂‰∫∫
		boolean isLead = false;

		String roleId = sysClient.getRoleIds("000000", "Â∏ÇÁ∫ßÂõõÂ§ßÁè≠Â≠ê").getData().replace(",","");
		String[] roleIds = user.getRoleId().split(",");//Âà§Êñ≠ËØ•Áî®Êà∑ÊòØ‰∏çÊòØÂ∏ÇÁ∫ßÂõõÂ§ßÁè≠Â≠êÈ¢ÜÂØº
		for (String id : roleIds) {
			if (id.equals(roleId)) {
				isLead = true;
				break;
			}
		}
		if(isLead){//ËØ¥ÊòéÂΩìÂâçÁî®Êà∑ÊòØÂ∏ÇÁ∫ßÂõõÂ§ßÁè≠Â≠ê
			List<User> users = userClient.getUserListByRoleId(roleId).getData();
			for (User user1 : users) {
				if(!user.getId().equals(user1.getId())){
					receiveUser += user1.getId()+",";
				}
			}

			//ÂèëÈÄÅÁü≠‰ø°ÂºÄÂßã 20230516
			//Áù£Êü•Áù£ÂäûÊâπÁ§∫„ÄÅÁïôË®Ä
			if("1".equals(messageInformation.getBusinessType())){
				String mobiles = "";
				//Áù£Êü•Áù£ÂäûÈúÄË¶ÅÂèëÈÄÅÊ∂àÊÅØÁöÑÂØπË±°ÔºöÁâµÂ§¥Âçï‰Ωç„ÄÅÁù£Âäû‰∫∫„ÄÅËØÑ‰ª∑‰∫∫„ÄÅ‚Äú@‚ÄùÂØπË±°„ÄÇÔºàÂ¶ÇÊûúÁù£Âäû‰∫∫ÂíåËØÑ‰ª∑‰∫∫ÊòØÂêå‰∏ÄÊâãÊú∫Âè∑ÔºåÂè™Âèë‰∏ÄÊ¨°Ôºâ
				SupervisionInfo supervisionInfo = iSupervisionInfoService.getById(messageInformation.getBusinessId());
				//1„ÄÅÁâµÂ§¥Âçï‰Ωç
				String[] qtdwNames = supervisionInfo.getLeadUnitName().split(",");//‰∫ãÈ°πÁâµÂ§¥Âçï‰ΩçÂêçÁß∞
				for (String qtdwName : qtdwNames) {
					//Ê†πÊçÆÈÉ®Èó®ÂêçÁß∞Ëé∑ÂèñÁî®Êà∑
					List<User> userListDx1 = iUserSearchClient.getDeptUsers(qtdwName).getData();
					if(userListDx1 != null && userListDx1.size() > 0){
						for(User userDx1 : userListDx1){
							mobiles += userDx1.getPhone()+",";
						}
					}
				}
				//2„ÄÅÁù£Âäû‰∫∫Ôºà‰∏Ä‰∏™Ôºâ
				String supervisor = supervisionInfo.getSupervisorName();
				//Ê†πÊçÆÈÉ®Èó®ÂêçÁß∞Ëé∑ÂèñÁî®Êà∑
				List<User> userListDx2 = iUserSearchClient.getDeptUsers(supervisor).getData();
				if(userListDx2 != null && userListDx2.size() > 0){
					for(User userDx2 : userListDx2){
						if(!mobiles.contains(userDx2.getPhone())){  //ÂéªÈô§ÈáçÂ§çÊâãÊú∫Âè∑
							mobiles += userDx2.getPhone()+",";
						}
					}
				}

				//3„ÄÅËØÑ‰ª∑‰∫∫Ôºà‰∏Ä‰∏™Ôºâ
				String evaluator = supervisionInfo.getEvaluatorName();
				//Ê†πÊçÆÈÉ®Èó®ÂêçÁß∞Ëé∑ÂèñÁî®Êà∑
				List<User> userListDx3 = iUserSearchClient.getDeptUsers(evaluator).getData();
				if(userListDx3 != null && userListDx3.size() > 0){
					for(User userDx3 : userListDx3){
						if(!mobiles.contains(userDx3.getPhone())){  //ÂéªÈô§ÈáçÂ§çÊâãÊú∫Âè∑
							mobiles += userDx3.getPhone()+",";
						}
					}
				}

				//4„ÄÅ@ÂØπË±°
				String atUserId = messageInformation.getAtUserId();
				if(StringUtil.isNotBlank(atUserId)){
					String[] userIdsDx4 = messageInformation.getAtUserId().split(",");
					for (String userIdDx4 : userIdsDx4) {
						List<User> userListDx4 = iUserSearchClient.listByUser(userIdDx4).getData();
						if(!mobiles.contains(userListDx4.get(0).getPhone())) {
							mobiles += userListDx4.get(0).getPhone();
						}
					}
				}
				log.info("Áù£ÂØüÁù£ÂäûÊâÄÊúâÈúÄË¶ÅÂèëÁü≠‰ø°ÁöÑÂè∑Á†ÅÔºö"+mobiles);
				if(StringUtil.isNotBlank(mobiles)){
					mobiles = mobiles.substring(0, mobiles.length() - 1);
					String content = "ÊÇ®Êúâ‰∏ÄÊù°È¢ÜÂØºÊâπÁ§∫ÔºåËØ∑ÁôªÂΩïÁù£ËÄÉ‰∏Ä‰ΩìÂåñÂπ≥Âè∞ËøõË°åÊü•Áúã„ÄÇ";
					smsDockingService.send(mobiles,content);
				}
			}
			//È°πÁõÆÁÆ°ÁêÜÊâπÁ§∫„ÄÅÁïôË®Ä
			if("3".equals(messageInformation.getBusinessType())){
				String mobiles = "";
				ProjectSummary projectSummary = projectSummaryService.getById(messageInformation.getBusinessId());
				//1„ÄÅÂ∏ÇÁõ¥Ë°å‰∏ö‰∏ªÁÆ°ÈÉ®Èó®
				String[] szhyzgbmNames = projectSummary.getSzhyzgbmName().split(",");
				for (String szhyzgbmName : szhyzgbmNames) {
					//Ê†πÊçÆÈÉ®Èó®ÂêçÁß∞Ëé∑ÂèñÁî®Êà∑
					List<User> userListXm1 = iUserSearchClient.getDeptUsers(szhyzgbmName).getData();
					if(userListXm1 != null && userListXm1.size() > 0){
						for(User userXm1 : userListXm1){
							mobiles += userXm1.getPhone()+",";
						}
					}
				}
				//2„ÄÅÂéøÁ∫ßÂåÖÊäìÈ¢ÜÂØº
				String[] xjbzlds = projectSummary.getXjbzld().split(",");
				for (String xjbzld : xjbzlds) {
					List<User> userListXm2 = iUserSearchClient.listByUser(xjbzld).getData();
					if(userListXm2 != null && userListXm2.size() > 0){
						for(User userXm2 : userListXm2){
							mobiles += userXm2.getPhone()+",";
						}
					}
				}
				//3„ÄÅË∞ÉÂ∫¶Âçï‰Ωç
				String[] dwmcNames = projectSummary.getDwmcName().split(",");
				for (String dwmcName : dwmcNames) {
					//Ê†πÊçÆÈÉ®Èó®ÂêçÁß∞Ëé∑ÂèñÁî®Êà∑
					List<User> userListXm3 = iUserSearchClient.getDeptUsers(dwmcName).getData();
					if(userListXm3 != null && userListXm3.size() > 0){
						for(User userXm3 : userListXm3){
							mobiles += userXm3.getPhone()+",";
						}
					}
				}
				//4„ÄÅ@ÂØπË±°
				String atUerId = messageInformation.getAtUserId();
				if(StringUtil.isNotBlank(atUerId)){
					String[] userIdsDx4 = atUerId.split(",");
					for (String userIdDx4 : userIdsDx4) {
						List<User> userListDx4 = iUserSearchClient.listByUser(userIdDx4).getData();
						if(!mobiles.contains(userListDx4.get(0).getPhone())) {
							mobiles += userListDx4.get(0).getPhone();
						}
					}
				}
				log.info("Áù£ÂØüÁù£ÂäûÊâÄÊúâÈúÄË¶ÅÂèëÁü≠‰ø°ÁöÑÂè∑Á†ÅÔºö"+mobiles);
				if(StringUtil.isNotBlank(mobiles)){
					mobiles = mobiles.substring(0, mobiles.length() - 1);
					String content = "ÊÇ®Êúâ‰∏ÄÊù°È¢ÜÂØºÊâπÁ§∫ÔºåËØ∑ÁôªÂΩïÁù£ËÄÉ‰∏Ä‰ΩìÂåñÂπ≥Âè∞ËøõË°åÊü•Áúã„ÄÇ";
					smsDockingService.send(mobiles,content);
				}
			}
			//ÂèëÈÄÅÁü≠‰ø°ÁªìÊùü 20230516
		}
		String authPostId = sysClient.getPostIdsByFuzzy("000000","ÁÆ°ÁêÜÂëò").getData();//Ëé∑ÂèñÁÆ°ÁêÜÂëòÂ≤ó‰Ωçid
		String leadPostId = sysClient.getPostIdsByFuzzy("000000","ÈÉ®Èó®È¢ÜÂØº").getData();//Ëé∑ÂèñÈ¢ÜÂØºÂ≤ó‰Ωçid

		if("3".equals(messageInformation.getBusinessType())){//È°πÁõÆÁÆ°ÁêÜÊâπÁ§∫/ÁïôË®Ä
			ProjectSummary projectSummary = projectSummaryService.getById(messageInformation.getBusinessId());
			if(isLead){
				//Â∏ÇÂßîÂäûÂÖ¨ÂÆ§„ÄÅÂ∏ÇÊîøÂ∫úÂäûÂÖ¨ÂÆ§„ÄÅÂ∏ÇÂèëÊîπÂßî
				String deptId1 = sysClient.getDeptIdsByFuzzy("000000","Â∏ÇÂßîÂäûÂÖ¨ÂÆ§").getData();
				String deptId2 = sysClient.getDeptIdsByFuzzy("000000","Â∏ÇÊîøÂ∫úÂäûÂÖ¨ÂÆ§").getData();
				String deptId3 = sysClient.getDeptIdsByFuzzy("000000","Â∏ÇÂèëÂ±ïÊîπÈù©Âßî").getData();
				List<User> users= iUserSearchClient.listByPostAndDept(leadPostId,deptId1).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÈ¢ÜÂØºÁî®Êà∑
				users.addAll(iUserSearchClient.listByPostAndDept(leadPostId,deptId2).getData());
				users.addAll(iUserSearchClient.listByPostAndDept(leadPostId,deptId3).getData());
				users.addAll(iUserSearchClient.listByPostAndDept(authPostId,deptId1).getData());
				users.addAll(iUserSearchClient.listByPostAndDept(authPostId,deptId2).getData());
				users.addAll(iUserSearchClient.listByPostAndDept(authPostId,deptId3).getData());
				//Â∏ÇÂèëÊîπÂßîÊäïËµÑÁßë
				receiveUser += PropConstant.getProjectShzhId("6207")+",";
				//Â∏ÇÁ∫ßË°å‰∏ö‰∏ªÁÆ°ÈÉ®Èó®
				String deptId4 = projectSummary.getSzhyzgbm();
				if(StringUtil.isNotBlank(deptId4)){
					users.addAll(iUserSearchClient.listByPostAndDept(leadPostId,deptId4).getData());
					users.addAll(iUserSearchClient.listByPostAndDept(authPostId,deptId4).getData());
				}
				//Ë∞ÉÂ∫¶Âçï‰Ωç
				String deptId5 = projectSummary.getDwmc();
				if(StringUtil.isNotBlank(deptId5)){
					users.addAll(iUserSearchClient.listByPostAndDept(leadPostId,deptId5).getData());
					users.addAll(iUserSearchClient.listByPostAndDept(authPostId,deptId5).getData());
				}
				//Â∏ÇÁ∫ßÂåÖÊäìÈ¢ÜÂØº
				String sjbzld = projectSummary.getSjbzld();
				if(StringUtil.isNotBlank(sjbzld)){
					receiveUser += sjbzld+",";
				}
				//Â¶ÇÊûú‰∏çÊòØÂ∏ÇÁ∫ßÈ°πÁõÆ
				if(!"6207".equals(projectSummary.getAreaCode())){
					//ÂéøÁ∫ßÂõõÂ§ßÁè≠Â≠ê
					String roleIdXj = sysClient.getRoleIds("000000", "ÂéøÁ∫ßÂõõÂ§ßÁè≠Â≠ê").getData().replace(",","");
					users.addAll(userClient.getUserListByRoleId(roleId).getData());
					//ÂéøÁ∫ßÂèëÊîπÂ±Ä
					receiveUser += PropConstant.getProjectShzhId(projectSummary.getAreaCode())+",";
					//ÂéøÂèëÊîπÂ±ÄÈ¢ÜÂØº
					String aa = PropConstant.getProjectShzhId(projectSummary.getAreaCode());
					System.out.println(aa);
					User u = userClient.userInfoById(Long.parseLong(Func.isNotEmpty(PropConstant.getProjectShzhId(projectSummary.getAreaCode()))?PropConstant.getProjectShzhId(projectSummary.getAreaCode()):"123456")).getData();
					if(u != null && StringUtil.isNotBlank(u.getDeptId())){
						users.addAll(iUserSearchClient.listByPostAndDept(leadPostId,u.getDeptId()).getData());
						users.addAll(iUserSearchClient.listByPostAndDept(authPostId,u.getDeptId()).getData());
					}
					//ÂéøÁ∫ßË°å‰∏ö‰∏ªÁÆ°ÈÉ®Èó®
					String deptId6 = projectSummary.getXqhyzgbm();
					if(StringUtil.isNotBlank(deptId6)){
						users.addAll(iUserSearchClient.listByPostAndDept(leadPostId,deptId6).getData());
						users.addAll(iUserSearchClient.listByPostAndDept(authPostId,deptId6).getData());
					}
				}
				for (User user1 : users) {
					if(!user.getId().equals(user1.getId())){
						receiveUser += user1.getId()+",";
					}
				}
			}
			String userIds= projectSummaryService.getUserIdListByProjId(projectSummary.getId(),AuthUtil.getUserId());//È°πÁõÆÂÜÖÁöÑ‰∫∫Âëò
			receiveUser += receiveUser + userIds;

			receiveUser += projectSummary.getCreateUser().toString()+",";
			String content = "„Äê"+userNameDecrypt+"„ÄëÂØπ„Äê"+projectSummary.getTitle()+"„ÄëËøõË°å‰∫ÜÁïôË®Ä/ÊâπÁ§∫";
			String appMsgType = "34";

			UnifyMessage message = new UnifyMessage();
			message.setMsgId(projectSummary.getId());
			message.setMsgTitle("È°πÁõÆÁÆ°ÁêÜÁïôË®Ä/ÊâπÁ§∫");
			message.setMsgType(appMsgType);
			message.setMsgStatus(0);
			message.setMsgPlatform("web");
			message.setMsgIntro(content);
			message.setTwoLevelType(appMsgType);
			message.setCreateTime(new Date());
			message.setMsgSubitem("È°πÁõÆÁÆ°ÁêÜ");
			message.setReceiveUser(StringUtils.isNotEmpty(messageInformation.getAtUserId())?messageInformation.getAtUserId()+","+AuthUtil.getUserId():quchong(receiveUser));//Êé•Êî∂‰∫∫ÂéªÈáç
			messageService.sendMessageInfo(message);

			message.setId(null);
			message.setMsgType("11");
			message.setMsgPlatform("app");
			messageService.sendMessageInfo(message);

			ProjectLog projectLog = new ProjectLog();//È°πÁõÆÊó•Âøó
			projectLog.setProjId(projectSummary.getId());
			projectLog.setHandleType("È°πÁõÆÊâπÁ§∫");
			projectLog.setHandleUser(userNameDecrypt);
			projectLog.setHandleDept(sysClient.getDept(Long.parseLong(user.getDeptId())).getData().getDeptName());
			String handleUserDecrypt = CryptoFactory.createCrypto(CryptoType.SM4).decrypt(projectLog.getHandleUser());
			projectLog.setHandleContent("„Äê"+handleUserDecrypt+"„ÄëÂØπ„Äê"+projectSummary.getTitle()+"„ÄëËøõË°å‰∫ÜÁïôË®Ä/ÊâπÁ§∫");
			projectLogService.save(projectLog);
		}else if("1".equals(messageInformation.getBusinessType())){//Áù£ÂØüÁù£ÂäûÊâπÁ§∫/ÁïôË®Ä
			SupervisionInfo supervisionInfo = iSupervisionInfoService.getById(messageInformation.getBusinessId());

			receiveUser += supervisionInfo.getCreateUser()+",";//‰∫ãÈ°π‰∏ãÂèëÂçï‰Ωç
			if(isLead){//Â¶ÇÊûúÂΩìÂâçÁî®Êà∑ÊòØÂõõÂ§ßÁè≠Â≠êÈ¢ÜÂØº
				String deptId = supervisionInfo.getCreateDept().toString();
				List<User> users= iUserSearchClient.listByPostAndDept(authPostId,deptId).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÁÆ°ÁêÜÂëòÁî®Êà∑
				if(users!=null){
					for(User u : users){
						receiveUser += u.getId()+",";
					}
				}

				users= iUserSearchClient.listByPostAndDept(leadPostId,deptId).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÈ¢ÜÂØºÁî®Êà∑
				if(users!=null){
					for(User u : users){
						receiveUser += u.getId()+",";
					}
				}

				users = userClient.getUserListByDeptId(deptId).getData();//Ëé∑ÂèñËØ•Âçï‰ΩçÊâÄÊúâÂàÜÁÆ°È¢ÜÂØº
				if(users!=null){
					for(User u : users){
						receiveUser += u.getId()+",";
					}
				}
			}
			String[] ids1 = supervisionInfo.getLeadUnit().split(",");//‰∫ãÈ°πÁâµÂ§¥Âçï‰Ωç
			for (String id : ids1) {
				List<User> users= iUserSearchClient.listByPostAndDept(authPostId,id).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÁÆ°ÁêÜÂëòÁî®Êà∑
				if(users!=null){
					for(User u : users){
						receiveUser += u.getId()+",";
					}
				}

				if(isLead){//Â¶ÇÊûúÂΩìÂâçÁî®Êà∑ÊòØÂõõÂ§ßÁè≠Â≠êÈ¢ÜÂØº
					users= iUserSearchClient.listByPostAndDept(leadPostId,id).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÈ¢ÜÂØºÁî®Êà∑
					if(users!=null){
						for(User u : users){
							receiveUser += u.getId()+",";
						}
					}

					users = userClient.getUserListByDeptId(id).getData();//Ëé∑ÂèñËØ•Âçï‰ΩçÊâÄÊúâÂàÜÁÆ°È¢ÜÂØº
					if(users!=null){
						for(User u : users){
							receiveUser += u.getId()+",";
						}
					}
				}
			}
			String[] ids2 = supervisionInfo.getDutyUnit().split(",");//‰∫ãÈ°πË¥£‰ªªÂçï‰Ωç
			for (String id : ids2) {
				List<User> users= iUserSearchClient.listByPostAndDept(authPostId,id).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÁÆ°ÁêÜÂëòÁî®Êà∑
				if(users!=null){
					for(User u : users){
						receiveUser += u.getId()+",";
					}
				}

				if(isLead){//Â¶ÇÊûúÂΩìÂâçÁî®Êà∑ÊòØÂõõÂ§ßÁè≠Â≠êÈ¢ÜÂØº
					users= iUserSearchClient.listByPostAndDept(leadPostId,id).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÈ¢ÜÂØºÁî®Êà∑
					if(users!=null){
						for(User u : users){
							receiveUser += u.getId()+",";
						}
					}

					users = userClient.getUserListByDeptId(id).getData();//Ëé∑ÂèñËØ•Âçï‰ΩçÊâÄÊúâÂàÜÁÆ°È¢ÜÂØº
					if(users!=null){
						for(User u : users){
							receiveUser += u.getId()+",";
						}
					}
				}
			}

			String content = "„Äê"+userNameDecrypt+"„ÄëÂØπ„Äê"+supervisionInfo.getServName()+"„ÄëËøõË°å‰∫ÜÁïôË®Ä/ÊâπÁ§∫";
			String msgType = "41";
			String appMsgType = "42";

			UnifyMessage message = new UnifyMessage();
			message.setMsgId(supervisionInfo.getId());
			message.setMsgTitle("Áù£Êü•Áù£ÂäûÁïôË®Ä/ÊâπÁ§∫");
			message.setMsgType(msgType);
			message.setMsgStatus(0);
			message.setMsgPlatform("web");
			message.setMsgIntro(content);
			message.setCreateTime(new Date());

			//ÂÖ≥‰∫é@ÂèëÈÄÅÊ∂àÊÅØ
			message.setReceiveUser(StringUtils.isNotEmpty(messageInformation.getAtUserId())?messageInformation.getAtUserId()+","+AuthUtil.getUserId():quchong(receiveUser));//Êé•Êî∂‰∫∫ÂéªÈáç
			messageService.sendMessageInfo(message);

			String value = dictBizClient.getValue(supervisionInfo.getServTypeOne(), supervisionInfo.getServTypeTwo()).getData();
			message.setId(null);
			message.setMsgPlatform("app");
			message.setMsgType(Constants.MSG_TYPE_APP_ONE_PSLY);
			message.setMsgSubitem(value);
			message.setTwoLevelType(appMsgType);
			messageService.sendMessageInfo(message);

			SupervisionLog log = new SupervisionLog();
			log.setServCode(supervisionInfo.getServCode());
			log.setOperationDept(user.getDeptId());
			log.setOperationDeptName(sysClient.getDeptName(Long.parseLong(user.getDeptId())).getData());
			log.setOperationUser(user.getId().toString());
			log.setOperationUserName(userNameDecrypt);
			log.setOperationType("8");
			log.setOperationTime(new Date());
			log.setContent("„Äê"+userNameDecrypt+"„ÄëÂØπ„Äê"+supervisionInfo.getServName()+"„ÄëËøõË°åÁïôË®Ä/ÊâπÁ§∫");
			supervisionLogService.save(log);
		}else if("2".equals(messageInformation.getBusinessType())){//ËÄÉÊ†∏ËØÑ‰ª∑
			//ÂèëÈÄÅÊ∂àÊÅØ
			AnnualEvaluation ae = annualEvaluationService.getById(messageInformation.getBusinessId());
			QuarterlyEvaluation qe = quarterlyEvaluationService.getById(messageInformation.getBusinessId());
			if(ae!=null){//Âπ¥Â∫¶ËØÑ‰ª∑
				String msgSubmit=dictBizClient.getValue("ndkp-type",ae.getType()).getData();
				String msgIntro = "„Äê"+userNameDecrypt+"„ÄëÂØπÂπ¥Â∫¶ËØÑ‰ª∑ÊåáÊ†áÔºö„Äê"+ae.getMajorTarget()+"„ÄëËøõË°åÁïôË®Ä/ÊâπÁ§∫";
				Long deptId=ae.getCreateDept();//ÊåáÊ†áÂàõÂª∫Âçï‰Ωç‰∏ãÈù¢ÁöÑÁõ∏ÂÖ≥‰∫∫Âëò‰πüË¶ÅÂèëÈÄÅ
				String[] ids = ae.getAppraiseObjectId().split(",");//ËÄÉÊ†∏ÂØπË±°Âçï‰Ωçids
				ArrayList<String> ids1List = new ArrayList<String>(Arrays.asList(ids));
				ids1List.add(deptId.toString());
				String[] ids1 = (String[]) ids1List.toArray(new String[0]);
				String[] ids2 = ae.getAppraiseDeptid().split(",");

				for (String id : ids1) {
					List<User> users= iUserSearchClient.listByPostAndDept(authPostId,id).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÁÆ°ÁêÜÂëòÁî®Êà∑
					if(users!=null){
						for(User u : users){
							receiveUser += u.getId()+",";
						}
					}
					if(isLead){
						users= iUserSearchClient.listByPostAndDept(leadPostId,id).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÈ¢ÜÂØºÁî®Êà∑
						if(users!=null){
							for(User u : users){
								receiveUser += u.getId()+",";
							}
						}
						users = userClient.getUserListByDeptId(id).getData();//Ëé∑ÂèñËØ•Âçï‰ΩçÊâÄÊúâÂàÜÁÆ°È¢ÜÂØº
						if(users!=null){
							for(User u : users){
								receiveUser += u.getId()+",";
							}
						}

					}
				}
				for (String id : ids2) {
					List<User> users= iUserSearchClient.listByPostAndDept(authPostId,id).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÁÆ°ÁêÜÂëòÁî®Êà∑
					if(users!=null){
						for(User u : users){
							receiveUser += u.getId()+",";
						}
					}
					if(isLead){
						users= iUserSearchClient.listByPostAndDept(leadPostId,id).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÈ¢ÜÂØºÁî®Êà∑
						if(users!=null){
							for(User u : users){
								receiveUser += u.getId()+",";
							}
						}
						users = userClient.getUserListByDeptId(id).getData();//Ëé∑ÂèñËØ•Âçï‰ΩçÊâÄÊúâÂàÜÁÆ°È¢ÜÂØº
						if(users!=null){
							for(User u : users){
								receiveUser += u.getId()+",";
							}
						}
					}
				}
				UnifyMessage message = new UnifyMessage();
				message.setMsgId(Long.valueOf(messageInformation.getBusinessId()));//Ê∂àÊÅØ‰∏ªÈîÆÔºà‰∏öÂä°‰∏ªÈîÆÔºâ
				message.setMsgTitle("Âπ¥Â∫¶ËØÑ‰ª∑ÊâπÁ§∫/ÁïôË®Ä");//Ê∂àÊÅØÊ†áÈ¢ò
				message.setMsgType("43");//Ê∂àÊÅØÁ±ªÂûãÔºåÂ≠óÂÖ∏ÁºñÁ†ÅÔºöweb_message_type
				message.setMsgPlatform("web");//Âπ≥Âè∞ÔºöwebÊàñapp
				message.setReceiveUser(StringUtils.isNotEmpty(messageInformation.getAtUserId())?messageInformation.getAtUserId()+","+AuthUtil.getUserId():quchong(receiveUser));
				message.setMsgIntro(msgIntro);//Ê∂àÊÅØÁÆÄ‰ªã
				message.setMsgSubitem(msgSubmit);//Ê∂àÊÅØÂàÜÈ°π
				message.setMsgStatus(StatusConstant.UNIFY_MESSAGE_0);
				message.setCreateTime(new Date());
				messageService.sendMessageInfo(message);

				message.setId(null);
				message.setMsgPlatform("app");
				message.setMsgType(Constants.MSG_TYPE_APP_ONE_PSLY);
				message.setTwoLevelType("46");//Âπ¥Â∫¶ÊâπÁ§∫ÁïôË®Ä
				messageService.sendMessageInfo(message);
			}else if(qe!=null){//Â≠£Â∫¶ËØÑ‰ª∑
				//ÂèëÈÄÅÊ∂àÊÅØ
				String msgSubmit=dictBizClient.getValue("jdpj-type",qe.getJdzbType()).getData();
				String msgIntro="";
				if (qe.getMajorTarget() != null && qe.getMajorTarget()!="") {
					msgIntro = "„Äê"+userNameDecrypt+"„ÄëÂØπÂ≠£Â∫¶ËØÑ‰ª∑ÊåáÊ†áÔºö„Äê"+qe.getMajorTarget()+"„ÄëËøõË°åÁïôË®Ä/ÊâπÁ§∫";
				}else if (qe.getFirstTarget() != null && qe.getFirstTarget()!="") {
					msgIntro = "„Äê"+userNameDecrypt+"„ÄëÂØπÂ≠£Â∫¶ËØÑ‰ª∑ÊåáÊ†áÔºö„Äê"+qe.getFirstTarget()+"„ÄëËøõË°åÁïôË®Ä/ÊâπÁ§∫";
				} else if (qe.getTwoTarget() != null && qe.getTwoTarget()!="") {
					msgIntro = "„Äê"+userNameDecrypt+"„ÄëÂØπÂ≠£Â∫¶ËØÑ‰ª∑ÊåáÊ†áÔºö„Äê"+qe.getTwoTarget()+"„ÄëËøõË°åÁïôË®Ä/ÊâπÁ§∫";
				}else if (qe.getImportWork()!= null && qe.getImportWork()!="") {
					msgIntro = "„Äê"+userNameDecrypt+"„ÄëÂØπÂ≠£Â∫¶ËØÑ‰ª∑ÊåáÊ†áÔºö„Äê"+qe.getImportWork()+"„ÄëËøõË°åÁïôË®Ä/ÊâπÁ§∫";
				} else {
					msgIntro = "„Äê"+userNameDecrypt+"„ÄëÂØπÂ≠£Â∫¶ËØÑ‰ª∑ÊåáÊ†áËøõË°åÁïôË®Ä/ÊâπÁ§∫";
				}

				Long deptId=qe.getCreateDept();//ÊåáÊ†áÂàõÂª∫Âçï‰Ωç‰∏ãÈù¢ÁöÑÁõ∏ÂÖ≥‰∫∫Âëò‰πüË¶ÅÂèëÈÄÅ
				String[] ids = qe.getCheckObjectId().split(",");//ËÄÉÊ†∏ÂØπË±°Âçï‰Ωçid
				ArrayList<String> ids1List = new ArrayList<String>(Arrays.asList(ids));
				ids1List.add(deptId.toString());
				String[] ids1 = (String[]) ids1List.toArray(new String[0]);
				for (String id : ids1) {
					List<User> users= iUserSearchClient.listByPostAndDept(authPostId,id).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÁÆ°ÁêÜÂëòÁî®Êà∑
					if(users!=null){
						for(User u : users){
							receiveUser += u.getId()+",";
						}
					}
					if(isLead){
						users= iUserSearchClient.listByPostAndDept(leadPostId,id).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÈ¢ÜÂØºÁî®Êà∑
						if(users!=null){
							for(User u : users){
								receiveUser += u.getId()+",";
							}
						}
						users = userClient.getUserListByDeptId(id).getData();//Ëé∑ÂèñËØ•Âçï‰ΩçÊâÄÊúâÂàÜÁÆ°È¢ÜÂØº
						if(users!=null){
							for(User u : users){
								receiveUser += u.getId()+",";
							}
						}
					}
				}
				String[] ids2 = qe.getAppraiseDeptid().split(",");
				for (String id : ids2) {
					List<User> users= iUserSearchClient.listByPostAndDept(authPostId,id).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÁÆ°ÁêÜÂëòÁî®Êà∑
					if(users!=null){
						for(User u : users){
							receiveUser += u.getId()+",";
						}
					}
					if(isLead){
						users= iUserSearchClient.listByPostAndDept(leadPostId,id).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÈ¢ÜÂØºÁî®Êà∑
						if(users!=null){
							for(User u : users){
								receiveUser += u.getId()+",";
							}
						}
						users = userClient.getUserListByDeptId(id).getData();//Ëé∑ÂèñËØ•Âçï‰ΩçÊâÄÊúâÂàÜÁÆ°È¢ÜÂØº
						if(users!=null){
							for(User u : users){
								receiveUser += u.getId()+",";
							}
						}
					}
				}

				UnifyMessage message = new UnifyMessage();
				message.setMsgId(Long.valueOf(messageInformation.getBusinessId()));//Ê∂àÊÅØ‰∏ªÈîÆÔºà‰∏öÂä°‰∏ªÈîÆÔºâ
				message.setMsgTitle("Â≠£Â∫¶ËØÑ‰ª∑ÊâπÁ§∫/ÁïôË®Ä");//Ê∂àÊÅØÊ†áÈ¢ò
				message.setMsgType("44");//Ê∂àÊÅØÁ±ªÂûãÔºåÂ≠óÂÖ∏ÁºñÁ†ÅÔºöweb_message_type
				message.setMsgPlatform("web");//Âπ≥Âè∞ÔºöwebÊàñapp
				message.setReceiveUser(StringUtils.isNotEmpty(messageInformation.getAtUserId())?messageInformation.getAtUserId()+","+AuthUtil.getUserId():quchong(receiveUser));//Êé•Êî∂‰∫∫ÂéªÈáç
				message.setMsgIntro(msgIntro);//Ê∂àÊÅØÁÆÄ‰ªã
				message.setMsgSubitem(msgSubmit);//Ê∂àÊÅØÂàÜÈ°π
				message.setMsgStatus(StatusConstant.UNIFY_MESSAGE_0);
				message.setCreateTime(new Date());
				messageService.sendMessageInfo(message);

				message.setId(null);
				message.setMsgPlatform("app");
				message.setMsgType(Constants.MSG_TYPE_APP_ONE_PSLY);
				message.setTwoLevelType("47");//Â≠£Â∫¶ÊâπÁ§∫ÁïôË®Ä
				messageService.sendMessageInfo(message);
			}
		}else if("4".equals(messageInformation.getBusinessType())){//Áª©ÊïàËÄÉÊ†∏-È¢ÜÂØºËØÑ‰ª∑
			Long  leaderAppriseId= messageInformation.getBusinessId();
			//Ëé∑ÂèñÈ¢ÜÂØºËØÑ‰ª∑ÂØπË±°
			LeaderApprise la =leaderAppriseService.getById(leaderAppriseId);
			//ÁªôÈ¢ÜÂØºËØÑ‰ª∑ÂàõÂª∫‰∫∫ÂèëÊ∂àÊÅØ
			Long createDept = la.getCreateDept();
			List<User> createDeptUsers= iUserSearchClient.listByPostAndDept(authPostId, String.valueOf(createDept)).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÁÆ°ÁêÜÂëòÁî®Êà∑
			if(createDeptUsers!=null){
				for(User u : createDeptUsers){
					receiveUser += u.getId()+",";
				}
			}
			//ÁªôËØÑ‰ª∑Âçï‰ΩçÂèëÊ∂àÊÅØ
			List<User> users= iUserSearchClient.listByPostAndDept(authPostId,la.getDeptId()).getData();//Ëé∑ÂèñÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÁÆ°ÁêÜÂëòÁî®Êà∑
			if(users!=null){
				for(User u : users){
					receiveUser += u.getId()+",";
				}
			}
			//ÂõõÂ§ßÁè≠Â≠êÁªô‰∏ãÈù¢È¢ÜÂØºÂèëÊ∂àÊÅØ
			if(isLead){
				users= iUserSearchClient.listByPostAndDept(leadPostId,la.getDeptId()).getData();//Ëé∑ÂèñË¥£‰ªªÂçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÈ¢ÜÂØºÁî®Êà∑
				if(users!=null){
					for(User u : users){
						receiveUser += u.getId()+",";
					}
				}
				users = userClient.getUserListByDeptId(la.getDeptId()).getData();//Ëé∑ÂèñËØ•Ë¥£‰ªªÂçï‰ΩçÊâÄÊúâÂàÜÁÆ°È¢ÜÂØº
				if(users!=null){
					for(User u : users){
						receiveUser += u.getId()+",";
					}
				}

				users= iUserSearchClient.listByPostAndDept(leadPostId, String.valueOf(createDept)).getData();//Ëé∑ÂèñÂàõÂª∫Âçï‰Ωç‰∏ãÈù¢ÊâÄÊúâÈ¢ÜÂØºÁî®Êà∑
				if(users!=null){
					for(User u : users){
						receiveUser += u.getId()+",";
					}
				}
				users = userClient.getUserListByDeptId(String.valueOf(createDept)).getData();//Ëé∑ÂèñÂàõÂª∫Âçï‰ΩçÊâÄÊúâÂàÜÁÆ°È¢ÜÂØº
				if(users!=null){
					for(User u : users){
						receiveUser += u.getId()+",";
					}
				}
			}
			//ÂèëÈÄÅÊ∂àÊÅØ
			String content = "„Äê"+userNameDecrypt+"„ÄëÈ¢ÜÂØºÂØπ„Äê"+la.getDeptName()+"„ÄëËøõË°å‰∫ÜÈ¢ÜÂØºËØÑ‰ª∑ÁïôË®Ä/ÊâπÁ§∫";
			UnifyMessage message = new UnifyMessage();
			message.setMsgId(Long.valueOf(la.getId()));//Ê∂àÊÅØ‰∏ªÈîÆÔºà‰∏öÂä°‰∏ªÈîÆÔºâ
			message.setMsgTitle("È¢ÜÂØºËØÑ‰ª∑");//Ê∂àÊÅØÊ†áÈ¢ò
			message.setMsgType("48");//Ê∂àÊÅØÁ±ªÂûãÔºåÂ≠óÂÖ∏ÁºñÁ†ÅÔºöweb_message_type
			message.setMsgPlatform("web");//Âπ≥Âè∞ÔºöwebÊàñapp
			message.setReceiveUser(StringUtils.isNotEmpty(messageInformation.getAtUserId())?messageInformation.getAtUserId()+","+AuthUtil.getUserId():quchong(receiveUser));
			message.setMsgIntro(content);//Ê∂àÊÅØÁÆÄ‰ªã
			message.setMsgSubitem("È¢ÜÂØºËØÑ‰ª∑");//Ê∂àÊÅØÂàÜÈ°π
			message.setMsgStatus(StatusConstant.UNIFY_MESSAGE_0);
			message.setCreateTime(new Date());
			messageService.sendMessageInfo(message);

			message.setId(null);
			message.setMsgPlatform("app");
			message.setMsgType(Constants.MSG_TYPE_APP_ONE_PSLY);
			message.setTwoLevelType("50");//È¢ÜÂØºËØÑ‰ª∑
			messageService.sendMessageInfo(message);
		}
		//return R.data(VSTool.encrypt(encryptSign, "Êìç‰ΩúÊàêÂäü", VSTool.CHN));
		return R.success("Êìç‰ΩúÊàêÂäüÔºÅ");
	}

	/**
	 * Êí§Âõû ÂÖ¨ÂÖ±ÊñπÊ≥ï-ÊâπÁ§∫/ÁïôË®Ä
	 * @param id
	 * @return
	 */
	@GetMapping("/revokeMsgAndFile")
	@ApiOperationSupport(order = 5)
	@ApiOperation(value = "Êí§Âõû-ÂÖ¨ÂÖ±ÊñπÊ≥ï-ÊâπÁ§∫/ÁïôË®Ä", notes = "‰º†ÂÖ•MessageInformationÂØπË±°")
	public R revoke(Long id) {
		iMessageInformationService.removeById(id);
		// Âà†Èô§Êñá‰ª∂‰ø°ÊÅØË°®ÁöÑÊï∞ÊçÆ
		iAppriseFilesService.remove(Wrappers.<AppriseFiles>lambdaQuery().eq(AppriseFiles::getBusinessId, id));

		String title = "Êí§ÂõûÊâπÁ§∫/ÁïôË®Ä";
		String businessId = String.valueOf(id);
		String businessTable = "MessageInformation";
		int businessType = BusinessType.DELETE.ordinal();
		String[] businessIds = businessId.split(",");
		if (businessIds.length > 0) {
			for (int i = 0; i < businessIds.length; i++) {
				SpringUtil.getBean(IOperLogService.class).saveLog(title, businessIds[i], businessTable, businessType);
			}
		} else {
			SpringUtil.getBean(IOperLogService.class).saveLog(title, businessId, businessTable, businessType);
		}

		return R.success("Êìç‰ΩúÊàêÂäüÔºÅ");
	}

	public String quchong(String res){
		String[] receiveUsers = res.split(",");
		List<String> receiveList = new ArrayList<>();
		String receiveUser = "";
		for (String s : receiveUsers) {
			if(!receiveList.contains(s)&&!s.equals(AuthUtil.getUserId().toString())){
				receiveList.add(s);
			}
		}
		for (String s : receiveList) {
			receiveUser += s+",";
		}
		return receiveUser;
	}
}
